---
title: "Prepare performance-test norms tables for OES"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Overview  


The code assumes a typical RStudio project folder hierarchy, with `INPUT-FILES` and `OUTPUT-FILES` folders at the first level.

### Input Files

##### Issues to consider:

* What is the primary lookup input (rawscore, SS, agestrat, other var?)
* Over how many levels is the input stratified (file, tab, column?)

The goal is to have code that functions as templates for 1-, 2-, and 3- level stratification. Three level stratification is the most complex, can it also be the most generic? Can the code be written for reading in a three-level (file, tab, column) .xlsx stratification, and then pared down for less complex inputs.

Consider:

* Requiring the file level stratification to always be form. Therefore, any lookup that is divided by form always has multiple input files.
* File name consists of 1, 2, or 3 elements separated by `-`, in a three-level strat, the nomenclature would be [fileStratVar]-[tabStratVar]-[lookupRel].xlsx, where [lookupRel] provides the variable in the far-left lookup column and the variable whose values are lookedup up in the remaining right-ward columns, separated by `To` 
      + thus, `parent-agestrat-rawToSS.xlsx`, `parent-agestratToCV.xlsx`, etc.
* Use read_xl and always .xlsx, for consistency?

##### Standardized File Naming

`[fileVarVal]-[tabVar]-[lookupRel].xlsx`

parent-rawToSS.xlsx = `parent-agestrat-rawToSS.xlsx`  
teacher-rawToSS.xlsx = `teacher-agestrat-rawToSS.xlsx`  
self-rawToSS.xlsx = `self-agestrat-rawToSS.xlsx`  


##### Types of Lookup files from DP-4

* single-tab, single-column, join by SS: `Percentile-Lookup-SS.csv` 
* single-tab, single-column, join by agestrat: `OES-age-labels.csv`

* multi-tab (form), single-column, join by rawscore: `GDS_lookup.xlsx`
* multi-tab (form), multi-column (scale), join by rawscore: `growth-score-lookup.xlsx`, `ageEquiv-form-lookup.xlsx`
* multi-tab (form X CI_value), multi-column (scale), join by agestrat: `Form-Agestrat-CV.xlsx`

* multi-file (form), multi-tab (agestrat), multi-column (scale), join by rawscore: `scale_lookup_interview.xlsx`, `scale_lookup_parent.xlsx`, `scale_lookup_teacher.xlsx`


Here and throughout, certain token markers are employed to designate user-input values that vary by project:  

* `{TOKEN}`: any value or series of values  
* `{FILE-PATH}`  
* `{FILE-NAME}` 

### Multi-file-tab-column lookups

##### Format of raw-to-SS lookup tables .xlsx

The raw-to-SS lookup tables by scale is the first buidling block for the OES input tables. The task is to lookup `SS`, and the basic operation is the many-to-one correspondence between `rawscore` and `SS`. That lookup correspondence is stratified over three levels:

1. columns (scale)
2. tabs (agestrat)
3. files (form)

The tab labels should express agestrat as a three-digit integer (with leading zeros). The value of this label is the lower-bound of the agestrat, expressed in months. Here are some examples:

* 4-6 months = 004
* 3:0-3:5 = 036
* 16 to 18 years = 192

The standard format for file names is: [form]-rawToSS.xlsx
- e.g., `parent-rawToSs.xlsx`

##### Format of CV lookup tables .xlsx

The lookup stratification over three levels (different from previous example):

1. columns (scale)
2. tabs (form)
3. files (CI interval)

* tab labels = form
* file names: CV90, CV95, etc.
* columns per tab (left to right):
      + agestrat (in integer format as above)
      + one column per scale, column name is scale acronym plus _CV90 or _CV95 (e.g., 'COG_CV90')
      + cell values are confidence values (CV)

##### Format of growth lookup tables .xlsx
* example of var that does not differ by agestrat, but does differ by form. In DP4, you had two such variables, growth score and GDS. Vars which are essentially raw to SS lookups, that do not differ by agestrat, can be handled in a single input table. There may be disjunctive raw score ranges involved (e.g., a low range for one lookup, and a high range for another).

We need a better generic file name for these scores than `growth.xlsx`, e.g.

The lookup stratification over two levels (different from previous example):

1. columns (scale)
2. tabs (form)

* tab labels = form
* file name: growth.xlsx
* columns per tab (left to right):
      + rawscore
      + one column per scale, column name is scale acronym plus _G (e.g., 'COG_G')
      + cell values are growth scores
  

#################### LOOK at whether all inputs can be expressed as multi-file-tab-colum, with consistency about which vars are expressed at which levels

<br>



###### VALID CODE TO RUN

```{r three_level_readin, eval=FALSE}
file_strat_var <- 'form'
file_strat_val <- c('parent', 'teacher', 'self')
tab_strat_var <- 'agestrat'
key_var <- 'raw'
col_var <- 'SS'

scale_readin <- function(x) {
  # express the directory paths to the input files as a char vec.
  here(
    paste0('INPUT-FILES/', x, '-', tab_strat_var, '-', key_var, 'To', col_var, '.xlsx')) %>%
    assign('path', ., envir = .GlobalEnv)


  # input file is multi-tabbed .xlsx. Tabs contain lookup tables for each
  # agestrat. read input file into a df, stacking tabs on top of one another, and
  # creating a new column 'agestrat' to identify the origin tab of each set of rows.
  path %>%
    excel_sheets() %>%
    set_names() %>%
    map_df(read_excel,
           path = path,
          .id = tab_strat_var)
}

scale_lookup_pre <- file_strat_val %>% 
  map(scale_readin) %>% 
  setNames(file_strat_val) %>% 
  bind_rows(.id = file_strat_var)
```

###### COMMENTED SNIPPETS
The generic code for reading an input file with stratification over file, tab, and table levels requries the user to designate token values. For the file-level variable, you must specify both the name (e.g., `'form'`) and the values (e.g., `c('parent', 'teacher', 'self')`). The table level of stratification captures the core lookup relationship between two variables:

* `key_var`: the lookup input, located in the table's far-left column; and,
* `col_var`: the lookup output, located in the columns to the right of the key column.
```{r three_level_readin, echo=1:5, eval=FALSE}
```
